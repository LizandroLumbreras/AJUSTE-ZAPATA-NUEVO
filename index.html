<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Inventario Total – Almacén Zapata</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
 body{
   font-family: Arial, sans-serif;
   background:#f4f4f4;
   padding:20px;
 }
 h2{
   color:#00416A;
   font-size:26px;
   margin-bottom:20px;
 }
 table{
   width:100%;
   border-collapse:collapse;
   background:white;
   margin-top:15px;
 }
 th,td{
   border:1px solid #ccc;
   padding:10px;
   text-align:center;
   font-size:15px;
 }
 th{
   background:#00416A;
   color:white;
 }
 .positivo{ color:green; font-weight:bold; }
 .negativo{ color:red; font-weight:bold; }
</style>

</head>
<body>

<h2>Inventario Total – Almacén Zapata</h2>

<table>
 <thead>
   <tr>
     <th>Código</th>
     <th>Descripción</th>
     <th>Entradas</th>
     <th>Salidas</th>
     <th>Existencia</th>
   </tr>
 </thead>
 <tbody id="tablaInventario"></tbody>
</table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// ----------------------
// CONFIGURACIÓN FIREBASE
// ----------------------
const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const tabla = document.getElementById("tablaInventario");

// OBJETO GLOBAL DEL INVENTARIO
let inventario = {};

// ----------------------
// UNIFICADOR DE CÓDIGOS
// ----------------------
function obtenerIdentificador(data) {
  // ENTRADAS: puede venir "codigo" o "productoID"
  // SALIDAS: solo viene "codigo"

  if (data.codigo && data.codigo !== "") return data.codigo;

  if (data.productoID && data.productoID !== "") return data.productoID;
  
  if (data.codigoBarra && data.codigoBarra !== "") return data.codigoBarra;
  return "SIN-CODIGO"; // fallback
}

// ----------------------
// FUNCIÓN QUE PROCESA ENTRADAS/SALIDAS
// ----------------------
function procesarDatos(coleccion, tipo) {
  onSnapshot(coleccion, (snap) => {
    snap.docChanges().forEach(change => {

      const data = change.doc.data();

      const id = obtenerIdentificador(data);  // UNIFICAMOS AQUÍ

      if (!inventario[id]) {
        inventario[id] = {
          descripcion: data.descripcion || "-",
          entradas: 0,
          salidas: 0
        };
      }

      const qty = Number(data.cantidad) || 0;

      if (tipo === "entrada") inventario[id].entradas += qty;
      if (tipo === "salida")  inventario[id].salidas  += qty;
    });

    dibujarTabla();
  });
}

// ----------------------
// DIBUJAR TABLA
// ----------------------
function dibujarTabla() {
  tabla.innerHTML = "";

  Object.keys(inventario).forEach(id => {
    const p = inventario[id];
    const existencia = p.entradas - p.salidas;

    tabla.innerHTML += `
      <tr>
        <td>${id}</td>
        <td>${p.descripcion}</td>
        <td>${p.entradas}</td>
        <td>${p.salidas}</td>
        <td class="${existencia < 0 ? 'negativo':'positivo'}">
          ${existencia}
        </td>
      </tr>
    `;
  });
}

// ----------------------
// ESCUCHAR DATOS EN VIVO
// ----------------------
procesarDatos(collection(db, "almacenes/almacen_zapata/entradas"), "entrada");
procesarDatos(collection(db, "almacenes/almacen_zapata/salidas"), "salida");

</script>

</body>
</html>
