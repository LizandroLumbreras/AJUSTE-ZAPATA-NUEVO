<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Inventario – Almacén Zapata</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
 body{
   font-family: Arial, sans-serif;
   background:#f4f4f4;
   padding:20px;
 }
 h2{
   color:#00416A;
   font-size:26px;
   margin-bottom:20px;
 }
 table{
   width:100%;
   border-collapse:collapse;
   background:white;
   margin-top:15px;
 }
 th,td{
   border:1px solid #ccc;
   padding:10px;
   text-align:center;
   font-size:15px;
 }
 th{
   background:#00416A;
   color:white;
 }
 .positivo{ color:green; font-weight:bold; }
 .negativo{ color:red; font-weight:bold; }
</style>
</head>

<body>

<h2>Inventario Total – Almacén Zapata</h2>

<table>
<thead>
   <tr>
     <th>Código</th>
     <th>Descripción</th>
     <th>Entradas</th>
     <th>Salidas</th>
     <th>Existencia</th>
   </tr>
</thead>
<tbody id="tablaInventario"></tbody>
</table>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getFirestore, collection, getDocs
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const tabla = document.getElementById("tablaInventario");


// =====================================================
// 1) CARGAR PRODUCTOS Y ORDENAR POR PROVEEDOR
// =====================================================
async function cargarProductos() {
  const ref = collection(db, "productos");
  const snap = await getDocs(ref);
  
  let productos = [];

  snap.forEach(docu => {
    const data = docu.data();

    productos.push({
      codigo: docu.id,
      descripcion: data.concepto || data.descripcion || "",
      proveedor: data.proveedor || "-",
      entradas: 0,
      salidas: 0
    });
  });

  // ordenar por proveedor y luego por código
  productos.sort((a, b) => {
    if (a.proveedor !== b.proveedor) return a.proveedor.localeCompare(b.proveedor);
    return a.codigo.localeCompare(b.codigo);
  });

  return productos;
}


// =====================================================
// 2) OBTENER ENTRADAS POR CÓDIGO
// =====================================================
async function obtenerEntradasPorCodigo(codigo) {
  const ref = collection(db, "almacenes/almacen_zapata/entradas");
  const snap = await getDocs(ref);

  let total = 0;

  snap.forEach(docu => {
    const data = docu.data();

    if (Array.isArray(data.productos)) {
      data.productos.forEach(p => {
        if (String(p.codigo) === String(codigo)) {
          total += Number(p.cantidad || 0);
        }
      });
    } 
    else if (data.codigo == codigo) {
      total += Number(data.cantidad || 0);
    }
  });

  return total;
}


// =====================================================
// 3) OBTENER SALIDAS POR CÓDIGO
// =====================================================
async function obtenerSalidasPorCodigo(codigo) {
  const ref = collection(db, "almacenes/almacen_zapata/salidas");
  const snap = await getDocs(ref);

  let total = 0;

  snap.forEach(docu => {
    const data = docu.data();

    if (Array.isArray(data.articulos)) {
      data.articulos.forEach(a => {
        if (String(a.codigo) === String(codigo)) {
          total += Number(a.cantidad || 0);
        }
      });
    }
    else if (data.codigo == codigo) {
      total += Number(data.cantidad || 0);
    }
  });

  return total;
}


// =====================================================
// 4) ARMAR INVENTARIO COMPLETO
// =====================================================
async function armarInventario() {
  const productos = await cargarProductos();
  const inventario = [];

  for (const prod of productos) {
    const entradas = await obtenerEntradasPorCodigo(prod.codigo);
    const salidas = await obtenerSalidasPorCodigo(prod.codigo);

    inventario.push({
      ...prod,
      entradas,
      salidas,
      existencia: entradas - salidas
    });
  }

  return inventario;
}


// =====================================================
// 5) DIBUJAR INVENTARIO AGRUPADO POR PROVEEDOR
// =====================================================
function dibujarInventario(inventario) {
  tabla.innerHTML = "";

  let proveedorActual = "";

  inventario.forEach(p => {
    if (p.proveedor !== proveedorActual) {
      proveedorActual = p.proveedor;

      tabla.innerHTML += `
        <tr style="background:#ccc; font-weight:bold;">
          <td colspan="5">${proveedorActual}</td>
        </tr>
      `;
    }

    tabla.innerHTML += `
      <tr>
        <td>${p.codigo}</td>
        <td>${p.descripcion}</td>
        <td>${p.entradas}</td>
        <td>${p.salidas}</td>
        <td class="${p.existencia < 0 ? "negativo" : "positivo"}">${p.existencia}</td>
      </tr>
    `;
  });
}


// =====================================================
// 6) INICIAR
// =====================================================
armarInventario().then(inv => {
  dibujarInventario(inv);
});

</script>
</body>
</html>
