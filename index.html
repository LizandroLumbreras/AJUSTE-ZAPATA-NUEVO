<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Inventario – Entradas vs Salidas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
 body{
   font-family: Arial;
   background:#f4f4f4;
   padding:20px;
 }
 h2{
   color:#00416A;
   font-size:26px;
   margin-bottom:20px;
 }
 table{
   width:100%;
   border-collapse:collapse;
   background:white;
   margin-top:10px;
 }
 th,td{
   border:1px solid #ccc;
   padding:8px;
   text-align:center;
   font-size:14px;
 }
 th{
   background:#00416A;
   color:white;
 }
 .positivo{color:green; font-weight:bold;}
 .negativo{color:red; font-weight:bold;}
</style>
</head>

<body>

<h2>Inventario – Entradas vs Salidas</h2>

<table>
<thead>
<tr>
  <th>Código</th>
  <th>Descripción</th>
  <th>Entradas</th>
  <th>Salidas</th>
  <th>Diferencia</th>
</tr>
</thead>

<tbody id="tablaInventario"></tbody>
</table>

<script type="module">

// ----------------------------------------------------------
// FIREBASE
// ----------------------------------------------------------
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, collection, query, where,
  getDocs, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ----------------------------------------------------------
// VARIABLES
// ----------------------------------------------------------
let productos = {};
let entradas = {};
let salidas = {};

let listos = {
  productos:false,
  entradas:false,
  salidas:false
};

const fechaCorte = new Date("2025-11-24T00:00:00");

function norm(c){
  return (c||"").toString().trim().padStart(12,"0");
}

// ----------------------------------------------------------
// 1. PRODUCTOS
// ----------------------------------------------------------
async function cargarProductos(){
  const snap = await getDocs(collection(db,"productos"));

  snap.forEach(d=>{
    const x = d.data();
    const codigo = norm(x.codigoBarra || x.codigo);
    productos[codigo] = {
      descripcion: x.concepto || x.descripcion || "-"
    };
  });

  listos.productos = true;
  intentar();
}

// ----------------------------------------------------------
// 2. ENTRADAS
// ----------------------------------------------------------
function cargarEntradas(){
  onSnapshot(collection(db,"almacenes/almacen_zapata/entradas"), snap=>{
    entradas = {};

    snap.forEach(docu=>{
      const x = docu.data();
      const f = x.fecha?.toDate?.() || new Date(x.fecha);
      if(f < fechaCorte) return;

      (x.productos||[]).forEach(p=>{
        const codigo = norm(p.codigoBarra || p.codigo);
        entradas[codigo] = (entradas[codigo] || 0) + Number(p.cantidad||0);
      });
    });

    listos.entradas = true;
    intentar();
  });
}

// ----------------------------------------------------------
// 3. SALIDAS
// ----------------------------------------------------------
function cargarSalidas(){
  onSnapshot(collection(db,"almacenes/almacen_zapata/salidas1.0"), snap=>{
    salidas = {};

    snap.forEach(docu=>{
      const x = docu.data();
      const f = x.timestamp?.toDate?.() || new Date(x.timestamp);
      if(f < fechaCorte) return;

      (x.articulos||[]).forEach(p=>{
        const codigo = norm(p.codigoBarra || p.codigo);
        salidas[codigo] = (salidas[codigo] || 0) + Number(p.cantidad||0);
      });
    });

    listos.salidas = true;
    intentar();
  });
}

// ----------------------------------------------------------
// DIBUJAR (solo productos con movimientos)
// ----------------------------------------------------------
function intentar(){
  if(!listos.productos || !listos.entradas || !listos.salidas) return;
  dibujar();
}

function dibujar(){
  const t = document.getElementById("tablaInventario");
  t.innerHTML = "";

  // Obtener lista de códigos que sí tuvieron movimientos
  const codigos = new Set([
    ...Object.keys(entradas),
    ...Object.keys(salidas)
  ]);

  codigos.forEach(codigo=>{
    const ent = entradas[codigo] || 0;
    const sal = salidas[codigo] || 0;
    const dif = ent - sal;

    const desc = productos[codigo]?.descripcion || "-";

    t.innerHTML += `
      <tr>
        <td>${codigo}</td>
        <td>${desc}</td>
        <td>${ent}</td>
        <td>${sal}</td>
        <td class="${dif<0?'negativo':'positivo'}">${dif}</td>
      </tr>
    `;
  });
}

// ----------------------------------------------------------
// INICIAR
// ----------------------------------------------------------
await cargarProductos();
cargarEntradas();
cargarSalidas();

</script>

</body>
</html>
