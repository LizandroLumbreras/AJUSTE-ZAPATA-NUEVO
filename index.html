<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Inventario Profesional – Almacén Zapata</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
 body{
   font-family: Arial, sans-serif;
   background:#f4f4f4;
   padding:20px;
 }
 h2{
   color:#00416A;
   font-size:26px;
   margin-bottom:20px;
 }
 table{
   width:100%;
   border-collapse:collapse;
   background:white;
   margin-top:15px;
 }
 th,td{
   border:1px solid #ccc;
   padding:10px;
   text-align:center;
   font-size:15px;
 }
 th{
   background:#00416A;
   color:white;
 }
 .positivo{ color:green; font-weight:bold; }
 .negativo{ color:red; font-weight:bold; }

 .btn{
   margin-top:20px; 
   padding:12px 20px; 
   background:#00416A; 
   color:white; 
   border:none; 
   border-radius:6px; 
   font-size:16px; 
   cursor:pointer;
 }
</style>
</head>

<body>

<h2>Inventario Total – Almacén Zapata (PROFESIONAL)</h2>

<table>
<thead>
   <tr>
     <th>Código</th>
     <th>Descripción</th>
     <th>Base</th>
     <th>Entradas nuevas</th>
     <th>Salidas nuevas</th>
     <th>Existencia real</th>
     <th>Inventario físico</th>
     <th>Diferencia</th>
   </tr>
</thead>

<tbody id="tablaInventario"></tbody>
</table>

<button id="btnGuardarAjustes" class="btn">Guardar ajustes de inventario</button>

<script type="module">

// ===============================
// IMPORTS FIREBASE
// ===============================
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getFirestore, collection, doc, query, where,
  getDocs, setDoc, addDoc, onSnapshot 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// ===============================
// CONFIG
// ===============================
const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ===============================
// VARIABLES
// ===============================
const tabla = document.getElementById("tablaInventario");

let productos = {};
let inventarioBase = {};
let nuevasEntradas = {};
let nuevasSalidas = {};

let productosListos = false;
let baseLista = false;
let entradasListas = false;
let salidasListas = false;

const fechaCorte = new Date("2025-11-24T00:00:00"); // corte operativo

// ===============================
// NORMALIZADORES
// ===============================
function normCodigo(cod){
  if(!cod) return "";
  cod = cod.toString().trim();
  return cod.padStart(12,"0");
}

// ===============================
// 1. CARGAR PRODUCTOS ACTIVOS
// ===============================
async function cargarProductos(){
  const q = query(collection(db,"productos"), where("activo","==",true));
  const snap = await getDocs(q);

  snap.forEach(docu=>{
    const d = docu.data();
    const codigo = normCodigo(d.codigoBarra || d.codigo || "");
    if(!codigo) return;

    productos[codigo] = {
      descripcion: d.concepto || d.descripcion || "-",
      proveedor: d.proveedor || "SIN PROVEEDOR"
    };
  });

  productosListos = true;
  intentarDibujar();
}

// ===============================
// 2. CARGAR INVENTARIO BASE
// ===============================
async function cargarBase(){
  const snap = await getDocs(collection(db,"inventario_base"));

  snap.forEach(docu=>{
    const codigo = normCodigo(docu.id);
    const d = docu.data();
    inventarioBase[codigo] = d.existencia || 0;
  });

  baseLista = true;
  intentarDibujar();
}

// ===============================
// 3. CARGAR NUEVAS ENTRADAS
// ===============================
function cargarEntradas(){
  const ref = collection(db,"almacenes/almacen_zapata/entradas");

  onSnapshot(ref,snap=>{
    nuevasEntradas = {};

    snap.forEach(docu=>{
      const data = docu.data();
      const fecha = data.fecha?.toDate?.() || new Date(data.fecha);

      if(fecha <= fechaCorte) return;

      if(Array.isArray(data.productos)){
        data.productos.forEach(item=>{
          const codigo = normCodigo(
            item.codigoBarra ||
            item.codigobarras ||
            item.codigo ||
            item.productoId ||
            item.productoID ||
            ""
          );

          const cant = Number(item.cantidad || 0);

          if(!nuevasEntradas[codigo]) nuevasEntradas[codigo] = 0;
          nuevasEntradas[codigo] += cant;
        });
      }

      if(Array.isArray(data.conceptos_detalle)){
        data.conceptos_detalle.forEach(item=>{
          const codigo = normCodigo(item.codigo || item.productoId || "");
          const cant = Number(item.cantidad || item.cantidadTotal || 0);

          if(!nuevasEntradas[codigo]) nuevasEntradas[codigo] = 0;
          nuevasEntradas[codigo] += cant;
        });
      }
    });

    entradasListas = true;
    intentarDibujar();
  });
}

// ===============================
// 4. CARGAR NUEVAS SALIDAS
// ===============================
function cargarSalidas(){
  const ref = collection(db,"almacenes/almacen_zapata/salidas1.0");

  onSnapshot(ref,snap=>{
    nuevasSalidas = {};

    snap.forEach(docu=>{
      const data = docu.data();
      const fecha = data.timestamp?.toDate?.() || new Date(data.timestamp);

      if(fecha <= fechaCorte) return;

      if(Array.isArray(data.articulos)){
        data.articulos.forEach(item=>{
          const codigo = normCodigo(
            item.codigoBarra ||
            item.codigobarra ||
            item.codigo ||
            item.productoID ||
            item.productoId ||
            ""
          );

          const cant = Number(item.cantidad || 0);

          if(!nuevasSalidas[codigo]) nuevasSalidas[codigo] = 0;
          nuevasSalidas[codigo] += cant;
        });
      }
    });

    salidasListas = true;
    intentarDibujar();
  });
}

// ===============================
// 5. DIBUJAR TABLA TOTAL
// ===============================
function intentarDibujar(){
  if(!productosListos || !baseLista || !entradasListas || !salidasListas) return;
  dibujar();
}

function dibujar(){

  tabla.innerHTML = "";

  let porProveedor = {};

  Object.keys(productos).forEach(codigo=>{
    const p = productos[codigo];

    const base   = inventarioBase[codigo] || 0;
    const ent    = nuevasEntradas[codigo] || 0;
    const sal    = nuevasSalidas[codigo] || 0;
    const exist  = base + ent - sal;

    if(!porProveedor[p.proveedor]) porProveedor[p.proveedor]=[];

    porProveedor[p.proveedor].push({codigo, base, ent, sal, exist, descripcion: p.descripcion});
  });

  Object.keys(porProveedor).sort().forEach(prov=>{

    tabla.innerHTML += `
      <tr>
        <td colspan="8" style="
          background: linear-gradient(to right,#00416A,#0c6cbd);
          color:white; font-size:20px; font-weight:bold;
        ">
          ${prov}
        </td>
      </tr>
    `;

    porProveedor[prov].sort((a,b)=>a.codigo.localeCompare(b.codigo));

    porProveedor[prov].forEach(item=>{
      const clase = item.exist < 0 ? "negativo":"positivo";

      tabla.innerHTML += `
        <tr>
          <td>${item.codigo}</td>
          <td>${item.descripcion}</td>
          <td>${item.base}</td>
          <td>${item.ent}</td>
          <td>${item.sal}</td>
          <td class="${clase}">${item.exist}</td>

          <td>
            <input type="number" 
              id="fisico_${item.codigo}"
              style="width:80px;padding:6px;"
              oninput="calcularDiferencia('${item.codigo}',${item.exist})">
          </td>

          <td id="dif_${item.codigo}" style="font-weight:bold;color:#555;">0</td>
        </tr>
      `;
    });

    tabla.innerHTML += `<tr><td colspan="8" style="background:#e6e6e6;height:8px;"></td></tr>`;
  });

}

// ===============================
// 6. CALCULAR DIFERENCIA
// ===============================
window.calcularDiferencia = function(codigo, existencia){
  const fis = Number(document.getElementById("fisico_"+codigo).value);
  const celda = document.getElementById("dif_"+codigo);

  if(isNaN(fis)){
    celda.textContent = "0";
    celda.style.color="#555";
    return;
  }

  const dif = fis - existencia;
  celda.textContent = dif;

  celda.style.color = dif>0?"green": dif<0?"red":"#555";
};

// ===============================
// 7. GUARDAR AJUSTES (ENTRADAS/SALIDAS) + ACTUALIZAR BASE
// ===============================
async function guardarAjustes(){

  let movimientosEntrada=[];
  let movimientosSalida=[];
  let nuevosBases={};

  for(const codigo of Object.keys(productos)){

    const base  = inventarioBase[codigo] || 0;
    const ent   = nuevasEntradas[codigo] || 0;
    const sal   = nuevasSalidas[codigo] || 0;
    const exist = base + ent - sal;

    const input = document.getElementById("fisico_"+codigo);
    if(!input) continue;

    const val = input.value.trim();
    if(val === "") continue;

    const fis = Number(val);
    if(isNaN(fis)) continue;

    const diferencia = fis - exist;
    if(diferencia === 0) continue;

    if(diferencia > 0){
      movimientosEntrada.push({codigo, cantidad: diferencia});
    }else{
      movimientosSalida.push({codigo, cantidad: Math.abs(diferencia)});
    }

    nuevosBases[codigo] = fis;
  }

  if(movimientosEntrada.length===0 && movimientosSalida.length===0){
    alert("No hay ajustes por aplicar");
    return;
  }

  const fecha = new Date();

  if(movimientosEntrada.length>0){
    await addDoc(collection(db,"almacenes/almacen_zapata/entradas"),{
      movimiento:"ajuste_inventario",
      fecha,
      productos:movimientosEntrada
    });
  }

  if(movimientosSalida.length>0){
    await addDoc(collection(db,"almacenes/almacen_zapata/salidas1.0"),{
      movimiento:"ajuste_inventario",
      timestamp:fecha,
      articulos:movimientosSalida
    });
  }

  for(const codigo of Object.keys(nuevosBases)){
    const descripcion = productos[codigo]?.descripcion || "-";
    const proveedor   = productos[codigo]?.proveedor || "-";

    await setDoc(doc(db,"inventario_base",codigo),{
      existencia: nuevosBases[codigo],
      descripcion,
      proveedor,
      actualizadoEn: fecha
    });
  }

  alert("Ajuste aplicado correctamente");
}

document.getElementById("btnGuardarAjustes").addEventListener("click",guardarAjustes);

// ===============================
// EJECUTAR
// ===============================
await cargarProductos();
await cargarBase();
cargarEntradas();
cargarSalidas();

</script>

</body>
</html>
