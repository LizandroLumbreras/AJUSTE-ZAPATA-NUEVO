<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ajuste Visual ‚Äì Inventario Inicial Zapata</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    body{font-family:Arial,sans-serif;padding:20px;background:#f0f2f5;position:relative;}
    h1,h3{color:#0d47a1;text-align:center;}
    table{width:100%;border-collapse:collapse;margin-top:10px;background:white;}
    th,td{border:1px solid #ccc;padding:6px;text-align:center;}
    th{background:#0d47a1;color:white;}
    #loader{text-align:center;padding:20px;}
    .spinner{margin:auto;width:40px;height:40px;border:4px solid #ccc;border-top:4px solid #0d47a1;border-radius:50%;animation:spin 1s linear infinite;}
    @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
    .marca-agua{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);opacity:.06;z-index:0;max-width:90%;pointer-events:none;}
    @media print{body{background:white;color:black;}button,#loader{display:none!important;}table{page-break-inside:avoid;}th{background:#e0e0e0!important;color:black!important;}}
    button{position:fixed;right:20px;border:none;padding:10px 15px;border-radius:5px;cursor:pointer;z-index:999;}
    #btnImprimir{top:20px;background:#0d47a1;color:white;}
    #btnGuardar{top:70px;background:darkgreen;color:white;}
    .fila-parpadeo-rojo{background-color:#ffcccc;animation:parpadeoFila 1s infinite;}
    @keyframes parpadeoFila{0%,100%{background-color:#ffcccc;}50%{background-color:white;}}
  </style>
</head>
<body>
  <img src="logo_proveedora.webp" class="marca-agua" alt="Marca de agua" />
  <div id="loader"><div class="spinner"></div><p>Cargando inventario inicial...</p></div>

  <h1>AJUSTE VISUAL INVENTARIO ‚Äì ZAPATA</h1>
  <button id="btnImprimir" onclick="window.print()">üñ®Ô∏è Imprimir</button>
  <button id="btnGuardar" onclick="guardarAjustes()">‚úÖ Guardar Ajustes</button>
  <h3 id="totalGlobal" style="text-align:left;margin-left:20px;">üí∞ TOTAL INVENTARIO: $0.00</h3>
  <div id="tablas"></div>

<script>
  // === üî• CONFIGURACI√ìN FIREBASE ===
  const firebaseConfig = {
    apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
    authDomain: "inventariopv-643f1.firebaseapp.com",
    projectId: "inventariopv-643f1",
    storageBucket: "inventariopv-643f1.appspot.com",
    messagingSenderId: "96242533231",
    appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const money = n => new Intl.NumberFormat('es-MX',{style:'currency',currency:'MXN'}).format(n);
  let totalGlobal = 0;

 // === üì¶ CARGAR INVENTARIO A PARTIR DEL 2025-11-06 ===
async function cargarInventario() {
  const snap = await db.collection("almacenes")
    .doc("almacen_zapata")
    .collection("entradas")
    .where("fecha", ">=", "2025-11-06")   // ‚Üê incluye inicial y todo lo posterior
    .get();

  const productos = {};
  snap.forEach(doc => {
    const d = doc.data();
    const linea = (d.linea && d.linea.trim()) || "SIN LINEA";
    if (!productos[linea]) productos[linea] = [];
    productos[linea].push({...d, id: doc.id});
  });

  for (const [linea, items] of Object.entries(productos)) {
    renderTabla(linea, items);
  }

  document.getElementById("loader").style.display = "none";
}
// === üî¢ MULTIPLICADORES FIJOS POR C√ìDIGO ===
const multiplicadoresFijos = {
  "2000733010008": 2,
  "7503009154239": 25,
  "752216095737": 40,
  "990110": 20,
  "143050": 25,
  "7502208804044": 25,
  "7702": 25,
  "7503027332022": 25,
  "134060": 25,
  "142540": 25,
  "4664": 25,
  "18905": 500,
  "7503020773877": 25,
  "7692": 10,
  "050001": 10,
  "7502208804747": 25,
  "141825": 25,
  "7502208800176": 40,
  "7502208800875": 20,
  "3261": 5,
  "7502208804990": 4,
  "7502208802378": 20,
  "142535": 25,
  "7693": 10,
  "352": 10,
  "13978": 2
};

  // === üìä RENDER DE TABLAS POR L√çNEA ===
  function renderTabla(linea, items) {
    const cont = document.getElementById("tablas");
    let totalLinea = 0;
    let html = `<h3>${linea}</h3>
      <table><thead><tr>
        <th>C√≥digo</th><th>Descripci√≥n</th><th>Costo s/IVA</th><th>Cantidad</th><th>Total</th>
        <th>Inventario F√≠sico</th><th>Diferencia</th>
      </tr></thead><tbody>`;

    items.forEach(p => {
      const cantidad = Number(p.cantidad) || 0;
      const costo = Number(p.costoSinImpuesto) || 0;
      const multiplicar = multiplicadoresFijos[p.codigo] || 1;
const total = cantidad * costo * multiplicar;
      totalLinea += total;
      totalGlobal += total;

      html += `<tr data-id="${p.id}">
        <td>${p.codigo || ""}</td>
        <td>${p.descripcion || ""}</td>
        <td>${money(costo)}</td>
        <td class="cantidad">${cantidad}</td>
        <td>${money(total)}</td>
        <td><input type="number" class="fisico" data-id="${p.id}" style="width:70px"></td>
        <td id="dif-${p.id}">0</td>
      </tr>`;
    });

    html += `</tbody></table>
      <p style="text-align:right;font-weight:bold;color:#0d47a1;">
      Total L√≠nea ${linea}: ${money(totalLinea)}</p>`;
    cont.innerHTML += html;
    document.getElementById("totalGlobal").textContent = "üí∞ TOTAL INVENTARIO: " + money(totalGlobal);
  }

  // === üßÆ DIFERENCIAS EN TIEMPO REAL ===
  document.addEventListener("input", e => {
    if (e.target.classList.contains("fisico")) {
      const tr = e.target.closest("tr");
      const cant = parseInt(tr.querySelector(".cantidad").innerText) || 0;
      const val = parseInt(e.target.value) || 0;
      const dif = val - cant;
      const celda = document.getElementById(`dif-${e.target.dataset.id}`);
      celda.textContent = dif;
      celda.style.color = dif > 0 ? "green" : dif < 0 ? "red" : "black";
    }
  });

 // === üíæ GUARDAR AJUSTES DIRECTAMENTE EN ENTRADAS ===
async function guardarAjustes() {
  const inputs = document.querySelectorAll(".fisico");
  let ajustes = 0;
  const batch = db.batch();

  for (const inp of inputs) {
    const val = inp.value;
    if (val === "") continue;

    const id = inp.dataset.id;
    const tr = inp.closest("tr");
    const cant = parseInt(tr.querySelector(".cantidad").innerText) || 0;
    const nuevo = parseInt(val);
    const dif = nuevo - cant;
    if (dif !== 0) {
      const ref = db
        .collection("almacenes")
        .doc("almacen_zapata")
        .collection("entradas")
        .doc(id);

      batch.update(ref, {
        cantidad: nuevo,
        ultimaModificacion: new Date().toISOString(),
        usuarioModifico: "Lizandro",
        motivo: "Ajuste f√≠sico manual"
      });

      ajustes++;
    }
  }

  if (ajustes > 0) {
    await batch.commit();
    alert(`‚úÖ ${ajustes} productos actualizados correctamente.`);
    location.reload();
  } else {
    alert("No hay diferencias que guardar.");
  }
}

  window.onload = cargarInventario;
</script>
</body>
</html>
