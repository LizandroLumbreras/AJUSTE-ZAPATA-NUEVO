<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Inventario – Almacén Zapata</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
 body{
   font-family: Arial, sans-serif;
   background:#f4f4f4;
   padding:20px;
 }
 h2{
   color:#00416A;
   font-size:26px;
   margin-bottom:20px;
 }
 table{
   width:100%;
   border-collapse:collapse;
   background:white;
   margin-top:15px;
 }
 th,td{
   border:1px solid #ccc;
   padding:10px;
   text-align:center;
   font-size:15px;
 }
 th{
   background:#00416A;
   color:white;
 }
 .positivo{ color:green; font-weight:bold; }
 .negativo{ color:red; font-weight:bold; }
 .btn{
   margin-top:20px; 
   padding:12px 20px; 
   background:#00416A; 
   color:white; 
   border:none; 
   border-radius:6px; 
   font-size:16px; 
   cursor:pointer;
 }
</style>
</head>

<body>

<h2>Inventario Total – Almacén Zapata</h2>

<table>
<thead>
   <tr>
     <th>Código</th>
     <th>Descripción</th>
     <th>Entradas</th>
     <th>Salidas</th>
     <th>Existencia</th>
     <th>Inventario físico</th>
     <th>Diferencia</th>
   </tr>
</thead>

<tbody id="tablaInventario"></tbody>
</table>

<button id="btnGuardarAjustes" class="btn">Guardar ajustes de inventario</button>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getFirestore, collection, query, where,
  getDocs, onSnapshot, addDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const tabla = document.getElementById("tablaInventario");

let inventario = {};     
let entradasListas = false;
let salidasListas  = false;

// ===============================
// NORMALIZADORES
// ===============================
function normCodigo(cod) {
  if (!cod) return "";
  cod = cod.toString().trim();
  if (cod.length === 12) return cod;
  return cod.padStart(12, "0");
}

function obtenerCantidad(obj) {
  return Number(obj.cantidad || 0);
}

function obtenerCodigo(obj) {
  return (
    obj.codigoBarra ||
    obj.codigobarra ||
    obj.codigoBarras ||
    obj.codigo ||
    obj.productoID ||
    obj.productoId ||
    ""
  ).toString().trim();
}

// ======================================================
// 1. LEER SOLO PRODUCTOS ACTIVOS CON PROVEEDOR
// ======================================================
async function cargarProductosProveedor() {

  const q = query(collection(db, "productos"), where("activo", "==", true));
  const snap = await getDocs(q);

  snap.forEach(doc => {
    const d = doc.data();

    if (!d.proveedor || d.proveedor.toString().trim() === "") return;

    const codigo = normCodigo(d.codigoBarra || d.codigo || "");

    inventario[codigo] = {
      proveedor: d.proveedor,
      descripcion: d.concepto || d.descripcion || "-",
      entradas: 0,
      salidas: 0
    };
  });
}

// ======================================================
// 2. PROCESAR ENTRADAS (TIPO 1 Y TIPO 2)
// ======================================================
function cargarEntradas() {
  const ref = collection(db, "almacenes/almacen_zapata/entradas");

  onSnapshot(ref, snap => {
    snap.forEach(docu => {
      const data = docu.data();

      // Entradas tipo 1 (conceptos_detalle)
      if (Array.isArray(data.conceptos_detalle)) {
        data.conceptos_detalle.forEach(item => {
          const codigo = normCodigo(item.codigo || item.productoId || "");
          const cantidad = Number(item.cantidad || item.cantidadTotal || 0);
          if (inventario[codigo]) inventario[codigo].entradas += cantidad;
        });
      }

      // Entradas tipo 2 (productos)
      if (Array.isArray(data.productos)) {
        data.productos.forEach(item => {
          const codigo = normCodigo(
            item.codigoBarra ||
            item.codigobarras ||
            item.codigo ||
            item.productoId ||
            item.productoID ||
            ""
          );
          const cantidad = Number(item.cantidad || 0);
          if (inventario[codigo]) inventario[codigo].entradas += cantidad;
        });
      }

    });

    entradasListas = true;
    if (entradasListas && salidasListas) dibujar();
  });
}

// ======================================================
// 3. PROCESAR SALIDAS (CON FECHA MÍNIMA)
// ======================================================

const fechaMinimaSalidas = new Date("2025-11-24T00:00:00");

function cargarSalidas() {
  const ref = collection(db, "almacenes/almacen_zapata/salidas1.0");

  onSnapshot(ref, snap => {

    snap.forEach(docu => {
      const data = docu.data();

      if (!data.timestamp) return;

      let fechaSalida;

      if (data.timestamp.toDate) fechaSalida = data.timestamp.toDate();
      else fechaSalida = new Date(data.timestamp);

      if (fechaSalida < fechaMinimaSalidas) return;

      if (Array.isArray(data.articulos)) {
        data.articulos.forEach(item => {

          const cod = normCodigo(obtenerCodigo(item));
          const cant = obtenerCantidad(item);

          if (inventario[cod]) {
            inventario[cod].salidas += cant;
          }

        });
      }

    });

    salidasListas = true;
    if (entradasListas && salidasListas) dibujar();
  });
}

// ======================================================
// 4. DIBUJAR TABLA COMPLETA CON FÍSICO + DIFERENCIA
// ======================================================
function dibujar() {
  tabla.innerHTML = "";

  const porProveedor = {};

  Object.keys(inventario).forEach(cod => {
    const p = inventario[cod];
    if (!porProveedor[p.proveedor]) porProveedor[p.proveedor] = [];
    porProveedor[p.proveedor].push({ codigo: cod, ...p });
  });

  const proveedoresOrdenados = Object.keys(porProveedor).sort();

  proveedoresOrdenados.forEach(prov => {

    tabla.innerHTML += `
      <tr>
        <td colspan="7" 
            style="
              background: linear-gradient(to right, #00416A, #0c6cbd);
              color: white;
              font-size:20px;
              font-weight:bold;
              padding:14px;
              border-top: 4px solid #003354;
            ">
            ${prov}
        </td>
      </tr>
    `;

    porProveedor[prov].sort((a,b) => a.codigo.localeCompare(b.codigo));

    porProveedor[prov].forEach(p => {

      const existencia = p.entradas - p.salidas;
      const clase = existencia < 0 ? "negativo" : "positivo";

      tabla.innerHTML += `
        <tr>
          <td>${p.codigo}</td>
          <td>${p.descripcion}</td>
          <td>${p.entradas}</td>
          <td>${p.salidas}</td>
          <td class="${clase}">${existencia}</td>

          <td>
            <input type="number"
                  id="fisico_${p.codigo}"
                  style="width:80px; padding:6px;"
                  oninput="calcularDiferencia('${p.codigo}', ${existencia})">
          </td>

          <td id="dif_${p.codigo}" style="font-weight:bold; color:#555;">
            0
          </td>
        </tr>
      `;
    });

    tabla.innerHTML += `
      <tr><td colspan="7" style="height:8px; background:#eaeaea;"></td></tr>
    `;
  });
}

// ======================================================
// 5. CALCULAR DIFERENCIA EN VIVO
// ======================================================
window.calcularDiferencia = function(codigo, existenciaActual) {

  const fisico = Number(document.getElementById("fisico_" + codigo).value);
  const celda = document.getElementById("dif_" + codigo);

  if (isNaN(fisico)) {
    celda.textContent = "0";
    celda.style.color = "#555";
    return;
  }

  const diferencia = fisico - existenciaActual;

  celda.textContent = diferencia;

  if (diferencia > 0) celda.style.color = "green"; 
  else if (diferencia < 0) celda.style.color = "red";
  else celda.style.color = "#555";
};

// ======================================================
// 6. GUARDAR AJUSTES DE INVENTARIO (ENTRADAS/SALIDAS)
// ======================================================
async function guardarAjustesInventario() {

  let ajustesEntrada = [];
  let ajustesSalida  = [];

  for (const codigo of Object.keys(inventario)) {
    const p = inventario[codigo];
    const existencia = p.entradas - p.salidas;

    const input = document.getElementById("fisico_" + codigo);
    if (!input) continue;

    const fisico = Number(input.value);
    if (isNaN(fisico) || fisico === "") continue;

    const diferencia = fisico - existencia;

    if (diferencia === 0) continue;

    if (diferencia > 0) {
      ajustesEntrada.push({ codigo, cantidad: diferencia });
    } else {
      ajustesSalida.push({ codigo, cantidad: Math.abs(diferencia) });
    }
  }

  if (ajustesEntrada.length === 0 && ajustesSalida.length === 0) {
    alert("No hay ajustes para guardar.");
    return;
  }

  const fecha = new Date();

  if (ajustesEntrada.length > 0) {
    await addDoc(collection(db, "almacenes/almacen_zapata/entradas"), {
      movimiento: "ajuste_inventario",
      fecha,
      productos: ajustesEntrada
    });
  }

  if (ajustesSalida.length > 0) {
    await addDoc(collection(db, "almacenes/almacen_zapata/salidas1.0"), {
      movimiento: "ajuste_inventario",
      timestamp: fecha,
      articulos: ajustesSalida
    });
  }

  alert("Ajustes aplicados correctamente.");
}

document.getElementById("btnGuardarAjustes").addEventListener("click", guardarAjustesInventario);

// ======================================================
// EJECUCIÓN
// ======================================================
await cargarProductosProveedor();
cargarEntradas();
cargarSalidas();

</script>

</body>
</html>
