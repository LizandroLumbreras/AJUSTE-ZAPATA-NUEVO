<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Inventario Real – Almacén Zapata</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family: 'Poppins',sans-serif;
  background:#f4f4f4;
  padding:20px;
}
h2{
  color:#00416A;
  font-size:28px;
  margin-bottom:20px;
  text-align:center;
}
table{
  width:100%;
  border-collapse:collapse;
  background:white;
  margin-top:10px;
}
th,td{
  border:1px solid #ccc;
  padding:8px;
  text-align:center;
  font-size:13px;
}
th{
  background:#00416A;
  color:white;
}
.positivo{ color:green; font-weight:bold; }
.negativo{ color:red; font-weight:bold; }

input[type='number']{
  width:80px;
  padding:4px;
  border-radius:5px;
  border:1px solid #aaa;
}
button{
  padding:5px 10px;
  background:#00416A;
  color:white;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
button:hover{
  background:#006199;
}
.proveedor-row{
  background:#d9e7f5;
  font-weight:bold;
}
</style>
</head>

<body>

<h2>Inventario Real – Almacén Zapata</h2>

<table>
<thead>
<tr>
  <th>Código</th>
  <th>Descripción</th>
  <th>Inicial</th>
  <th>Entradas</th>
  <th>Salidas</th>
  <th>Inventario Real</th>
  <th>Ajustar Inicial</th>
</tr>
</thead>

<tbody id="tablaInventario"></tbody>
</table>

<script type="module">

// --------------------------------------------------------------
// FIREBASE
// --------------------------------------------------------------
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, collection, doc, setDoc, getDocs, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// --------------------------------------------------------------
// VARIABLES
// --------------------------------------------------------------
let productos = {};
let entradas = {};
let salidas = {};
let iniciales = {};

let listos = {
  productos:false,
  entradas:false,
  salidas:false,
  iniciales:false
};

function norm(c){ 
  return (c||"").toString().trim().padStart(12,"0"); 
}

// --------------------------------------------------------------
// 1. CARGAR PRODUCTOS
// --------------------------------------------------------------
async function cargarProductos(){
  const snap = await getDocs(collection(db,"productos"));
  snap.forEach(d=>{
    const x = d.data();
    const codigo = norm(x.codigoBarra || x.codigo);

    productos[codigo] = {
      descripcion: x.concepto || x.descripcion || "-",
      proveedor: x.proveedor || null,
      activo: x.activo === true
    };
  });

  listos.productos = true;
  intentar();
}

// --------------------------------------------------------------
// 2. CARGAR ENTRADAS (conceptos_detalle)
// --------------------------------------------------------------
function cargarEntradas(){
  onSnapshot(collection(db,"almacenes/almacen_zapata/entradas"), snap=>{
    
    entradas = {};

    snap.forEach(docu=>{
      const x = docu.data();

      // ENTRADAS reales
      if (Array.isArray(x.conceptos_detalle)) {
        x.conceptos_detalle.forEach(item => {
          const codigo = norm(item.codigo || item.productoId || item.noIdentificacion);
          const cant = Number(item.cantidad || 0);
          entradas[codigo] = (entradas[codigo] || 0) + cant;
        });
      }

      // Compatibilidad con versiones anteriores
      if (Array.isArray(x.productos)) {
        x.productos.forEach(item=>{
          const codigo = norm(item.codigoBarra || item.codigo);
          const cant = Number(item.cantidad || 0);
          entradas[codigo] = (entradas[codigo] || 0) + cant;
        });
      }

    });

    listos.entradas = true;
    intentar();
  });
}

// --------------------------------------------------------------
// 3. CARGAR SALIDAS (salidas1.0 → articulos[])
// --------------------------------------------------------------
function cargarSalidas(){
  onSnapshot(collection(db,"almacenes/almacen_zapata/salidas1.0"), snap=>{
    
    salidas = {};

    snap.forEach(docu=>{
      const x = docu.data();

      if (Array.isArray(x.articulos)) {
        x.articulos.forEach(item => {
          const codigo = norm(item.codigo);
          const cant = Number(item.cantidad || 0);
          salidas[codigo] = (salidas[codigo] || 0) + cant;
        });
      }

    });

    listos.salidas = true;
    intentar();
  });
}

// --------------------------------------------------------------
// 4. CARGAR INVENTARIO INICIAL / AJUSTES
// --------------------------------------------------------------
function cargarIniciales(){
  onSnapshot(collection(db,"almacenes/almacen_zapata/ajustes"), snap=>{
    iniciales = {};
    snap.forEach(d=>{
      const x = d.data();
      iniciales[norm(x.codigo)] = Number(x.inventarioInicial || 0);
    });
    listos.iniciales = true;
    intentar();
  });
}

// --------------------------------------------------------------
// INTENTAR DIBUJAR
// --------------------------------------------------------------
function intentar(){
  if(!listos.productos || !listos.entradas || !listos.salidas || !listos.iniciales) return;
  dibujar();
}

// --------------------------------------------------------------
// 5. DIBUJAR INVENTARIO ORDENADO POR PROVEEDOR
// --------------------------------------------------------------
function dibujar(){
  const t = document.getElementById("tablaInventario");
  t.innerHTML = "";

  const grupos = {}; // proveedor : [productos]

  // SOLO mostrar productos que APARECEN EN SALIDAS
  const codigos = new Set(Object.keys(salidas));

  codigos.forEach(codigo=>{
    const prod = productos[codigo];

    // Si no existe el producto → excluir
    if (!prod) return;

    // Si NO tiene proveedor → excluir
    if (!prod.proveedor) return;

    // Si NO está activo → excluir
    if (prod.activo !== true) return;

    const desc = prod.descripcion || "-";
    const proveedor = prod.proveedor;

    const ini  = iniciales[codigo] || 0;
    const ent  = entradas[codigo] || 0;
    const sal  = salidas[codigo] || 0;

    const real = ini + ent - sal;

    if(!grupos[proveedor]) grupos[proveedor] = [];

    grupos[proveedor].push({
      codigo,
      descripcion: desc,
      ini,
      ent,
      sal,
      real
    });
  });

  // ORDENAR proveedores alfabéticamente
  const proveedoresOrdenados = Object.keys(grupos).sort();

  proveedoresOrdenados.forEach(proveedor => {

    // Fila de proveedor
    t.innerHTML += `
      <tr class="proveedor-row">
        <td colspan="7" style="text-align:left;padding:10px;font-size:15px;">
          PROVEEDOR: ${proveedor}
        </td>
      </tr>
    `;

    // Orden interno por descripción
    grupos[proveedor].sort((a,b)=> a.descripcion.localeCompare(b.descripcion));

    // Render de productos
    grupos[proveedor].forEach(item=>{
      t.innerHTML += `
        <tr>
          <td>${item.codigo}</td>
          <td>${item.descripcion}</td>
          <td>${item.ini}</td>
          <td>${item.ent}</td>
          <td>${item.sal}</td>
          <td class="${item.real<0?'negativo':'positivo'}">${item.real}</td>

          <td>
           <input type="number" id="aj_${item.codigo}" placeholder="${item.ini}">
            <button onclick="guardarAjuste('${item.codigo}')">Guardar</button>
          </td>
        </tr>
      `;
    });

  });

}

// --------------------------------------------------------------
// 6. GUARDAR AJUSTE DE INVENTARIO (INDIVIDUAL) — OPCIONAL
// --------------------------------------------------------------
window.guardarAjuste = async function(codigo){
  const v = Number(document.getElementById("aj_"+codigo).value || 0);

  await setDoc(
    doc(db,"almacenes/almacen_zapata/ajustes",codigo),
    {
      codigo,
      inventarioInicial: v,
      lastUpdate: new Date().toISOString()
    },
    { merge:true }
  );
};

// --------------------------------------------------------------
// 7. GUARDAR TODOS LOS AJUSTES (BOTÓN ÚNICO)
// --------------------------------------------------------------
window.guardarTodosLosAjustes = async function(){
  const inputs = document.querySelectorAll("input[id^='aj_']");
  let guardados = 0;

  for(const input of inputs){
    if(input.value === "") continue;

    const codigo = input.id.replace("aj_","");
    const valor = Number(input.value);
    if(isNaN(valor)) continue;

    await setDoc(
      doc(db,"almacenes/almacen_zapata/ajustes",codigo),
      {
        codigo,
        inventarioInicial: valor,
        lastUpdate: new Date().toISOString()
      },
      { merge:true }
    );

    guardados++;
  }

  alert(
    guardados === 0
      ? "No se detectaron ajustes para guardar."
      : `Se guardaron ${guardados} ajustes correctamente.`
  );
};

// --------------------------------------------------------------
// INICIAR
// --------------------------------------------------------------
cargarProductos();
cargarEntradas();
cargarSalidas();
cargarIniciales();
</script>
  <br>
<div style="text-align:center;margin-top:20px;">
  <button onclick="guardarTodosLosAjustes()" style="padding:10px 20px;font-size:15px;">
    Guardar ajustes realizados
  </button>
</div>
</body>
</html>
