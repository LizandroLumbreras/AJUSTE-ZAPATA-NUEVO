<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ajuste Visual - Almac√©n Zapata</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f0f2f5;
      position: relative;
    }
    h1, h2, h3 {
      color: #0d47a1;
      text-align: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    th {
      background: #0d47a1;
      color: white;
    }
    #loader {
      text-align: center;
      padding: 20px;
    }
    .spinner {
      margin: auto;
      width: 40px;
      height: 40px;
      border: 4px solid #ccc;
      border-top: 4px solid #0d47a1;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .marca-agua {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      opacity: 0.06;
      z-index: 0;
      max-width: 90%;
      pointer-events: none;
    }
    @media print {
      body { background: white; color: black; }
      button, #loader { display: none !important; }
      h2, h3 { color: black !important; }
      table { page-break-inside: avoid; }
      table, th, td { font-size: 11pt; }
      th { background: #e0e0e0 !important; color: black !important; }
      h2::before { content: "üìü Inventario Impreso ‚Äî "; }
    }
    .fila-parpadeo-rojo {
      animation: parpadeoFila 1s infinite;
      background-color: #ffcccc;
    }
    @keyframes parpadeoFila {
      0%, 100% { background-color: #ffcccc; }
      50% { background-color: white; }
    }
    button {
      position: fixed;
      right: 20px;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      z-index: 999;
    }
    #btnImprimir {
      top: 20px;
      background: #0d47a1;
      color: white;
    }
    #btnGuardar {
      top: 70px;
      background: darkgreen;
      color: white;
    }
  </style>
</head>
<body>
  <img src="logo_proveedora.webp" class="marca-agua" alt="Marca de agua" />
  <div id="loader">
    <div class="spinner"></div>
    <p>Cargando inventario visual...</p>
  </div>
  <h1>AJUSTE VISUAL INVENTARIO - ZAPATA</h1>
  <button id="btnImprimir" onclick="window.print()">üñ®Ô∏è Imprimir</button>
  <button id="btnGuardar" onclick="guardarAjustes()">‚úÖ Guardar Ajustes</button>
  <h3 id="totalGlobal" style="color:#0d47a1; text-align:left; margin-left:20px;">
    üí∞ TOTAL INVENTARIO ZAPATA: $0.00
  </h3>
  <div id="tablas"></div>
  <script>
    // Configuraci√≥n Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.appspot.com",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const codigosExentos = ["2382", "3062", "3217", "210004", "7503000134506", "7503000134803"];
    let totalGlobalInventario = 0;

    async function cargarDatos() {
      const entradasSnap = await db.collection("almacenes").doc("almacen_zapata").collection("entradas").get();
      const salidasSnap = await db.collection("almacenes").doc("almacen_zapata").collection("salidas").get();
      const productosSnap = await db.collection("productos").get();

      // Construir productos agrupados
      const codigosAgrupados = {};
      productosSnap.forEach(doc => {
        const data = doc.data();
        const codigo = doc.id;
        if (!codigosAgrupados[codigo]) {
          const base = data.costoSinImpuesto || 0;
          const esExento = codigosExentos.includes(codigo);
          codigosAgrupados[codigo] = {
            descripcion: data.concepto || "Sin descripci√≥n",
            costo: esExento ? base : base * 1.16,
            impuesto: esExento ? "Exento" : "Con IVA",
            entradas: 0,
            salidas: 0
          };
        }
      });

      // Sumar entradas
      entradasSnap.forEach(doc => {
        const data = doc.data();
        if (Array.isArray(data.articulos)) {
          data.articulos.forEach(item => {
            if (codigosAgrupados[item.codigo]) {
              codigosAgrupados[item.codigo].entradas += item.cantidad;
            }
          });
        } else {
          if (codigosAgrupados[data.codigo]) {
            codigosAgrupados[data.codigo].entradas += data.cantidad;
          }
        }
      });

      // Sumar salidas
      salidasSnap.forEach(doc => {
        const data = doc.data();
        if (Array.isArray(data.articulos)) {
          data.articulos.forEach(item => {
            if (codigosAgrupados[item.codigo]) {
              codigosAgrupados[item.codigo].salidas += item.cantidad;
            }
          });
        }
      });

      // Categor√≠as
      const agrupado = {
        "CHAROLA": ["365","355","357","364","363","7037","2178","14578","7016","7221","1347"],
        "CONTENEDOR": ["7689","7686","2096","1886","2097","1655","1901","7417","352"],
        "PLATOS TERMICOS": ["12146","2409","2410","020013","2411","2188","2408","2190","3987","3614"],
        "CHAROLAS COLORES": ["1347","020124","020126","020127","020053","2351","1349","055500500","2350","450029","3864","021788","3866","3865","3738","14579"],
        "CONTENEDORES NEGROS": ["1020321","020270","1450066","450065","1750178","750178","750182"],
        "VASOS PLASTICO": ["020167","020262","2397","2161","2162","5853","4410","5078","1502","1623","4395","1386413864","020066","5666","450083","020183"],
        "LINEA BIO": ["020319","020318","020297","020306","020303","020300","020312","020310","450089","450100"],
        "LINEA EU": ["450091","450090","141450","450086","450087","450101","450095","32322050"],
        "POPOTE BIO": ["450079","450081"],
        "BIO CONTENEDOR": ["7701200","7702200","8802200","8801200","9902200","9901200"],
        "JAGUAR Y JUGUERO": ["020051","020054","2033","2164","020053","1484","2161","1639","2162","020052","020055","1356","1355","290005","1409","1486","1485","450053","450002"],
        "REFRESCOS": ["060028","4451","250010","7506241","210010","7504033","7503034","7505035","14220","3062","2382","3217","210004","7503000134803","7503000134506"],
        "VASOS": ["104104","106106","108108","110110","112112","114114","116116","132132","704704","706706","708708","712712","716716","732732","760760","404404","406406","408408","410410","412412","414414","416416","516516","120120","7501431206038","7501825638728","7501825638742","020103","5283","5282"],
        "CAMISETA": ["4660","7702","13609","150100","150103","150104","7503009154239","7503009154246","7503024644128","7503024644951"],
        "BOLSA_CAMISETA": ["150101","150102"],
        "BOLSA_PLANA": ["142535","142540","144060","145070","147090","7503009154307"],
        "BOLSA_ROLLO": ["131825","132030","134060"],
        "CIMAPLAST": ["7501508800237"]
      };

      // Renderizar categor√≠as
      for (const [linea, codigos] of Object.entries(agrupado)) {
        await renderTabla(linea, codigos, codigosAgrupados);
      }

      // Detectar SIN CATEGOR√çA
      const codigosTodasCategorias = Object.values(agrupado).flat();
      const sinCategoria = [];
      for (const codigo of Object.keys(codigosAgrupados)) {
        if (!codigosTodasCategorias.includes(codigo)) {
          sinCategoria.push(codigo);
        }
      }

      if (sinCategoria.length > 0) {
        await renderTabla("SIN CATEGOR√çA", sinCategoria, codigosAgrupados);
      }

      document.getElementById("loader").style.display = "none";
    }

    async function renderTabla(nombre, codigos, productos) {
      const formatter = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' });
      let totalInventarioCosteado = 0;

      let tablaHTML = `<h3>${nombre}</h3>`;
      tablaHTML += `<table><thead><tr>
        <th>C√≥digo</th>
        <th>Descripci√≥n</th>
        <th>Costo</th>
        <th>Impuesto</th>
        <th>Inventario</th>
        <th>Inventario Costeado</th>
        <th>Inventario F√≠sico</th>
        <th>Diferencia</th>
      </tr></thead><tbody>`;

      for (const codigo of codigos) {
        const p = productos[codigo];
        if (!p) continue;
        const inventario = p.entradas - p.salidas;
        const totalCosteado = p.costo * inventario;
        totalInventarioCosteado += totalCosteado;
        totalGlobalInventario += totalCosteado;

        const claseFila = inventario < 0 ? 'fila-parpadeo-rojo' : '';
        tablaHTML += `<tr class="${claseFila}" data-codigo="${codigo}">
          <td>${codigo}</td>
          <td>${p.descripcion}</td>
          <td>${formatter.format(p.costo)}</td>
          <td>${p.impuesto}</td>
          <td><strong class="inventario">${inventario}</strong></td>
          <td><strong>${formatter.format(totalCosteado)}</strong></td>
          <td><input type="number" data-codigo="${codigo}" class="fisico-input" style="width: 70px;" /></td>
          <td id="diferencia-${codigo}">0</td>
        </tr>`;
      }

      tablaHTML += `</tbody></table><p style="text-align:right; font-weight:bold; color:#0d47a1;">üßæ Total Inventario Costeado: ${formatter.format(totalInventarioCosteado)}</p>`;
      document.getElementById("tablas").innerHTML += tablaHTML;
      document.getElementById("totalGlobal").innerText =
        "üí∞ TOTAL INVENTARIO ZAPATA: " + formatter.format(totalGlobalInventario);
    }

    // Mostrar diferencias en vivo
    document.addEventListener("input", (e) => {
      if (e.target.classList.contains("fisico-input")) {
        const codigo = e.target.dataset.codigo;
        const fila = e.target.closest("tr");
        const inventario = parseInt(fila.querySelector(".inventario")?.innerText || "0");
        const valor = e.target.value;

        const celda = document.getElementById(`diferencia-${codigo}`);

        if (valor === "") {
          celda.innerText = "0";
          celda.style.color = "black";
          return;
        }

        const fisico = parseInt(valor) || 0;
        const diferencia = fisico - inventario;

        celda.innerText = diferencia;
        celda.style.color = diferencia < 0 ? "red" : diferencia > 0 ? "green" : "black";
      }
    });

    // Guardar ajustes
    async function guardarAjustes() {
      const inputs = document.querySelectorAll(".fisico-input");
      const batch = db.batch();
      const coleccionEntradas = db.collection("almacenes").doc("almacen_zapata").collection("entradas");

      let ajustesRealizados = 0;

      for (const input of inputs) {
        const valor = input.value;
        if (valor === "") continue;

        const fisico = parseInt(valor) || 0;
        const codigo = input.dataset.codigo;
        const fila = input.closest("tr");
        const inventario = parseInt(fila.querySelector(".inventario").innerText) || 0;
        const diferencia = fisico - inventario;

        if (diferencia !== 0) {
          const nuevoDoc = coleccionEntradas.doc();
          batch.set(nuevoDoc, {
            codigo: codigo,
            cantidad: diferencia,
            motivo: "Ajuste de inventario f√≠sico",
            fecha: new Date().toISOString()
          });
          ajustesRealizados++;
        }
      }

      if (ajustesRealizados > 0) {
        await batch.commit();
        alert(`‚úÖ ${ajustesRealizados} ajustes guardados como entradas`);
        location.reload();
      } else {
        alert("No hay diferencias que guardar.");
      }
    }

    window.onload = cargarDatos;
  </script>
</body>
</html>
