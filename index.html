<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ajuste Visual ‚Äì Inventario Inicial Zapata</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    body{font-family:Arial,sans-serif;padding:20px;background:#f0f2f5;position:relative;}
    h1,h3{color:#0d47a1;text-align:center;}
    table{width:100%;border-collapse:collapse;margin-top:10px;background:white;}
    th,td{border:1px solid #ccc;padding:6px;text-align:center;}
    th{background:#0d47a1;color:white;}
    #loader{text-align:center;padding:20px;}
    .spinner{margin:auto;width:40px;height:40px;border:4px solid #ccc;border-top:4px solid #0d47a1;border-radius:50%;animation:spin 1s linear infinite;}
    @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
    .marca-agua{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);opacity:.06;z-index:0;max-width:90%;pointer-events:none;}
    @media print{body{background:white;color:black;}button,#loader{display:none!important;}table{page-break-inside:avoid;}th{background:#e0e0e0!important;color:black!important;}}
    button{position:fixed;right:20px;border:none;padding:10px 15px;border-radius:5px;cursor:pointer;z-index:999;}
    #btnImprimir{top:20px;background:#0d47a1;color:white;}
    #btnGuardar{top:70px;background:darkgreen;color:white;}
    #btnReporte{top:120px;background:#b71c1c;color:white;}
  </style>
</head>
<body>
  <img src="logo_proveedora.webp" class="marca-agua" alt="Marca de agua" />
  <div id="loader"><div class="spinner"></div><p>Cargando inventario inicial...</p></div>

  <h1>AJUSTE VISUAL INVENTARIO ‚Äì ZAPATA</h1>
  <button id="btnImprimir" onclick="window.print()">üñ®Ô∏è Imprimir</button>
  <button id="btnGuardar" onclick="guardarAjustes()">‚úÖ Guardar Ajustes</button>
  <button id="btnReporte">üìÑ Generar Reporte</button>

  <h3 id="totalGlobal" style="text-align:left;margin-left:20px;">üí∞ TOTAL INVENTARIO: $0.00</h3>
  <div id="tablas"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.appspot.com",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const money = n => new Intl.NumberFormat('es-MX',{style:'currency',currency:'MXN'}).format(n);
let totalGlobal = 0;

// === Multiplicadores por c√≥digo ===
const multiplicadoresFijos = {
  "2000733010008": 2,"7503009154239": 25,"752216095737": 40,"990110": 20,"143050": 25,
  "7502208804044": 25,"7702": 25,"7503027332022": 25,"134060": 25,"142540": 25,"4664": 25,
  "18905": 500,"7503020773877": 25,"7692": 10,"020003": 10,"7502208804747": 25,"141825": 25,
  "7502208800176": 40,"7502208800875": 20,"3261": 5,"7502208804990": 4,"7502208802378": 20,
  "142535": 25,"020004": 10,"352": 10,"13978": 2,"020247": 1000
};

// === Cargar inventario desde entradas y salidas ===
async function cargarInventario() {
  const FECHA_CORTE = "2025-11-06";
  const entradasSnap = await db.collection("almacenes")
    .doc("almacen_zapata").collection("entradas")
    .where("fecha", ">=", FECHA_CORTE).get();

  const salidasSnap = await db.collection("almacenes")
    .doc("almacen_zapata").collection("salidas")
    .where("fecha", ">=", FECHA_CORTE).get();

  const stock = {};

  // === üîπ SUMAR ENTRADAS ===
  entradasSnap.forEach(doc => {
    const d = doc.data();
    if (Array.isArray(d.conceptos_detalle)) {
      d.conceptos_detalle.forEach(c => {
        const codigo = String(c.productoId || "").trim();
        if (!codigo) return;
        stock[codigo] = (stock[codigo] || 0) + (Number(c.cantidad) || 0);
      });
    } else if (d.codigo && d.cantidad) {
      const codigo = String(d.codigo).trim();
      stock[codigo] = (stock[codigo] || 0) + (Number(d.cantidad) || 0);
    }
  });

  // === üîπ RESTAR SALIDAS ===
  salidasSnap.forEach(doc => {
    const d = doc.data();
    if (Array.isArray(d.productos)) {
      d.productos.forEach(p => {
        const codigo = String(p.productoId || p.codigo || "").trim();
        if (!codigo) return;
        stock[codigo] = (stock[codigo] || 0) - (Number(p.cantidad) || 0);
      });
    } else if (d.codigo && d.cantidad) {
      const codigo = String(d.codigo).trim();
      stock[codigo] = (stock[codigo] || 0) - (Number(d.cantidad) || 0);
    }
  });

  // === üîπ CONSTRUIR TABLA ===
  const productos = {};
  for (const codigo in stock) {
    if (stock[codigo] <= 0) continue;
    const linea = "INVENTARIO DESDE 06/NOV";
    if (!productos[linea]) productos[linea] = [];
    productos[linea].push({
      id: codigo,
      codigo,
      descripcion: codigo,
      cantidad: stock[codigo],
      costoSinImpuesto: 0
    });
  }

  // === Cargar descripciones y costos desde "productos" ===
  for (const linea in productos) {
    for (const p of productos[linea]) {
      const prodSnap = await db.collection("productos").doc(p.codigo).get();
      if (prodSnap.exists) {
        const d = prodSnap.data();
        p.descripcion = d.concepto || d.descripcion || p.codigo;
        p.costoSinImpuesto = d.costoSinImpuesto || 0;
      }
    }
  }

  // Renderizar
  for (const [linea, items] of Object.entries(productos)) renderTabla(linea, items);
  document.getElementById("loader").style.display = "none";
}

// === Renderizar tabla ===
function renderTabla(linea, items) {
  const cont = document.getElementById("tablas");
  let totalLinea = 0;
  let html = `<h3>${linea}</h3>
  <table><thead><tr>
    <th>C√≥digo</th><th>Descripci√≥n</th><th>Costo s/IVA</th><th>Cantidad</th><th>Total</th>
    <th>Inventario F√≠sico</th><th>Diferencia</th>
  </tr></thead><tbody>`;

  items.forEach(p => {
    const cantidad = Number(p.cantidad) || 0;
    const costo = Number(p.costoSinImpuesto) || 0;
    const multiplicar = multiplicadoresFijos[p.codigo] || 1;
    const total = cantidad * costo * multiplicar;
    totalLinea += total;
    totalGlobal += total;

    html += `<tr data-id="${p.id}">
      <td>${p.codigo}</td>
      <td>${p.descripcion}</td>
      <td>${money(costo)}</td>
      <td class="cantidad">${cantidad}</td>
      <td>${money(total)}</td>
      <td><input type="number" class="fisico" data-id="${p.id}" style="width:70px"></td>
      <td id="dif-${p.id}">0</td>
    </tr>`;
  });

  html += `</tbody></table>
  <p style="text-align:right;font-weight:bold;color:#0d47a1;">
  Total L√≠nea ${linea}: ${money(totalLinea)}</p>`;
  cont.innerHTML += html;
  document.getElementById("totalGlobal").textContent =
    "üí∞ TOTAL INVENTARIO: " + money(totalGlobal);
}

// === Calcular diferencias en tiempo real ===
document.addEventListener("input", e => {
  if (e.target.classList.contains("fisico")) {
    const tr = e.target.closest("tr");
    const cant = parseInt(tr.querySelector(".cantidad").innerText) || 0;
    const val = parseInt(e.target.value) || 0;
    const dif = val - cant;
    const celda = document.getElementById(`dif-${e.target.dataset.id}`);
    celda.textContent = dif;
    celda.style.color = dif > 0 ? "green" : dif < 0 ? "red" : "black";
  }
});

// === Guardar ajustes ===
async function guardarAjustes() {
  const inputs = document.querySelectorAll(".fisico");
  let ajustes = 0;
  const batch = db.batch();

  for (const inp of inputs) {
    const val = inp.value;
    if (val === "") continue;
    const id = inp.dataset.id;
    const tr = inp.closest("tr");
    const cant = parseInt(tr.querySelector(".cantidad").innerText) || 0;
    const nuevo = parseInt(val);
    const dif = nuevo - cant;
    if (dif !== 0) {
      const ref = db.collection("almacenes")
        .doc("almacen_zapata").collection("entradas").doc(id);
      batch.update(ref, {
        cantidad: nuevo,
        ultimaModificacion: new Date().toISOString(),
        usuarioModifico: "Lizandro",
        motivo: "Ajuste f√≠sico manual"
      });
      ajustes++;
    }
  }

  if (ajustes > 0) {
    await batch.commit();
    alert(`‚úÖ ${ajustes} productos actualizados correctamente.`);
    location.reload();
  } else alert("No hay diferencias que guardar.");
}

// === Generar reporte totalizado ===
document.getElementById("btnReporte").addEventListener("click", generarReporte);
function generarReporte() {
  const tablas = document.querySelectorAll("#tablas table");
  let filas = [];

  tablas.forEach(tabla => {
    const linea = tabla.previousElementSibling?.innerText || "SIN LINEA";
    tabla.querySelectorAll("tbody tr").forEach(tr => {
      const celdas = tr.querySelectorAll("td");
      if (celdas.length >= 5) {
        const codigo = celdas[0].innerText.trim();
        const descripcion = celdas[1].innerText.trim();
        const cantidad = parseFloat(celdas[3].innerText.trim()) || 0;
        const total = parseFloat(celdas[4].innerText.replace(/[^0-9.]/g,'')) || 0;
        filas.push({linea, codigo, descripcion, cantidad, total});
      }
    });
  });

  const totalGlobalReporte = filas.reduce((s,f)=>s+f.total,0);
  let html = `
  <html><head><title>Reporte Totalizado</title>
  <style>
    body{font-family:'Poppins',sans-serif;padding:20px;}
    h1{color:#0d47a1;text-align:center;margin-bottom:20px;}
    h2{text-align:right;color:#0d47a1;}
    h3{color:#0d47a1;margin-top:25px;}
    table{width:100%;border-collapse:collapse;margin-top:8px;}
    th,td{border:1px solid #ccc;padding:6px;text-align:center;}
    th{background:#0d47a1;color:white;}
    .total-grande{font-size:22px;font-weight:bold;color:#0d47a1;text-align:right;margin-top:25px;}
    @media print{button{display:none;}}
  </style></head><body>
  <h1>REPORTE TOTALIZADO ‚Äì INVENTARIO ZAPATA</h1>
  <h2>Total Global: ${money(totalGlobalReporte)}</h2>`;

  let lineaActual = "";
  filas.forEach((f, i) => {
    if (f.linea !== lineaActual) {
      if (i > 0) html += "</tbody></table>";
      html += `<h3>${f.linea}</h3>
      <table><thead><tr><th>C√≥digo</th><th>Descripci√≥n</th><th>Piezas</th><th>Total</th></tr></thead><tbody>`;
      lineaActual = f.linea;
    }
    html += `<tr><td>${f.codigo}</td><td>${f.descripcion}</td><td>${f.cantidad}</td><td>${money(f.total)}</td></tr>`;
  });

  html += `</tbody></table>
  <p class="total-grande">TOTAL GENERAL: ${money(totalGlobalReporte)}</p>
  <button onclick="window.print()">üñ®Ô∏è Imprimir</button>
  </body></html>`;

  const win = window.open("", "_blank");
  win.document.write(html);
  win.document.close();
}

window.onload = cargarInventario;
</script>
</body>
</html>
