<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Inventario ‚Äì Almac√©n Zapata</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
 body{
   font-family: Arial, sans-serif;
   background:#f4f4f4;
   padding:20px;
 }
 h2{
   color:#00416A;
   font-size:26px;
   margin-bottom:20px;
 }
 table{
   width:100%;
   border-collapse:collapse;
   background:white;
   margin-top:15px;
 }
 th,td{
   border:1px solid #ccc;
   padding:10px;
   text-align:center;
   font-size:15px;
 }
 th{
   background:#00416A;
   color:white;
 }
 .positivo{ color:green; font-weight:bold; }
 .negativo{ color:red; font-weight:bold; }
</style>
</head>

<body>

<h2>Inventario Total ‚Äì Almac√©n Zapata</h2>

<table>
<thead>
   <tr>
     <th>C√≥digo</th>
     <th>Descripci√≥n</th>
     <th>Entradas</th>
     <th>Salidas</th>
     <th>Existencia</th>
   </tr>
</thead>
<tbody id="tablaInventario"></tbody>
</table>


<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getFirestore, collection, onSnapshot, doc, getDoc,
  query, where, getDocs
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);


// =====================================================
// VARIABLES
// =====================================================
let inventario = {};
let cacheDescripciones = {};
const tabla = document.getElementById("tablaInventario");


// =====================================================
// DETECTAR C√ìDIGO (TODAS LAS VARIANTES)
// =====================================================
function obtenerCodigoEntrada(data) {

  return (
    data.codigoBarra ||
    data.codigobarra ||
    data.codigoBarras ||
    data.codigo_barras ||
    data.codigo ||
    data.productoId ||
    data.productoID ||
    data.productoid ||
    ""
  ).toString().trim();
}

// =====================================================
// DETECTAR CANTIDAD
// =====================================================
function obtenerCantidad(data) {
  return Number(data.cantidad || 0);
}


// =====================================================
// OBTENER DESCRIPCI√ìN (TODAS LAS VARIANTES)
// PRIORIDAD:
// 1) descripci√≥n de entrada
// 2) productoInterno
// 3) producto en Firestore (ID / codigoBarra / codigobarras)
// =====================================================
function normalizarCodigo(codigo) {
  codigo = codigo.toString().trim();
  if (codigo.length === 12) return codigo;
  return codigo.padStart(12, "0");
}


async function obtenerDescripcion(codigo, dEntrada, dInterno) {

  if (dEntrada) return dEntrada;
  if (dInterno) return dInterno;

  codigo = normalizarCodigo(codigo);

  if (cacheDescripciones[codigo]) {
    return cacheDescripciones[codigo];
  }

  let desc = null;

  // 1. Buscar por codigoBarra EXACTO
  let q1 = query(collection(db, "productos"), where("codigoBarra", "==", codigo));
  let qs1 = await getDocs(q1);

  if (!qs1.empty) {
    const d = qs1.docs[0].data();
    desc = d.concepto || d.descripcion || d.nombre || "-";
    cacheDescripciones[codigo] = desc;
    return desc;
  }

  // 2. Buscar por ID EXACTO
  const ref = doc(db, `productos/${codigo}`);
  const snap = await getDoc(ref);

  if (snap.exists()) {
    const d = snap.data();
    desc = d.concepto || d.descripcion || d.nombre || "-";
    cacheDescripciones[codigo] = desc;
    return desc;
  }

  // 3. Buscar por ID sin ceros
  const codigoSinCeros = codigo.replace(/^0+/, "");
  const ref2 = doc(db, `productos/${codigoSinCeros}`);
  const snap2 = await getDoc(ref2);

  if (snap2.exists()) {
    const d = snap2.data();
    desc = d.concepto || d.descripcion || d.nombre || "-";
    cacheDescripciones[codigo] = desc;
    return desc;
  }

  // Nada encontrado
  cacheDescripciones[codigo] = "-";
  return "-";
}

// =====================================================
// PROCESAR ENTRADAS
// =====================================================
function procesarEntradas(ref) {

  onSnapshot(ref, async snap => {

    snap.forEach(docu => {
      const data = docu.data();

      // ARRAY productos[]
      if (Array.isArray(data.productos)) {
        data.productos.forEach(item => {

          const codigo = obtenerCodigoEntrada(item);
          const cantidad = obtenerCantidad(item);

          // TODAS las variantes de descripci√≥n
          const descripcion =
            item.descripcion ||
            item.descripcion_producto ||
            item.descripcionEntrada ||
            item.desc ||
            item.nombre ||
            "";

          const productoInterno =
            item.productoInterno ||
            item.productointerno ||
            item.producto_interno ||
            item.producto ||
            "";

          if (!inventario[codigo]) {
            inventario[codigo] = {
              descripcion: "-",
              entradas: 0,
              salidas: 0,
              descEntrada: descripcion,
              descInterna: productoInterno
            };
          }

          inventario[codigo].descEntrada = descripcion;
          inventario[codigo].descInterna = productoInterno;

          inventario[codigo].entradas += cantidad;
        });

        return;
      }

      // ENTRADA SIMPLE
      const codigo = obtenerCodigoEntrada(data);
      const cantidad = obtenerCantidad(data);

      const descripcion =
        data.descripcion ||
        data.descripcion_producto ||
        data.descripcionEntrada ||
        data.desc ||
        data.nombre ||
        "";

      const productoInterno =
        data.productoInterno ||
        data.productointerno ||
        data.producto_interno ||
        data.producto ||
        "";

      if (!inventario[codigo]) {
        inventario[codigo] = {
          descripcion: "-",
          entradas: 0,
          salidas: 0,
          descEntrada: descripcion,
          descInterna: productoInterno
        };
      }

      inventario[codigo].descEntrada = descripcion;
      inventario[codigo].descInterna = productoInterno;
      inventario[codigo].entradas += cantidad;
    });

    actualizarDescripciones();
  });
}


// =====================================================
// PROCESAR SALIDAS
// =====================================================
function procesarSalidas(ref) {

  onSnapshot(ref, snap => {

    snap.forEach(docu => {
      const data = docu.data();

      // üî• 1. Si trae ARRAY articulos[], procesarlo
      if (Array.isArray(data.articulos)) {
        data.articulos.forEach(item => {

          const codigo = obtenerCodigoEntrada(item);
          const cantidad = obtenerCantidad(item);

          const descripcion =
            item.descripcion ||
            item.nombre ||
            "";

          if (!inventario[codigo]) {
            inventario[codigo] = {
              descripcion: "-",
              entradas: 0,
              salidas: 0,
              descEntrada: "",
              descInterna: ""
            };
          }

          inventario[codigo].salidas += cantidad;
          inventario[codigo].descEntrada = descripcion;
        });

        return;
      }

      // üî• 2. Salida simple
      const codigo = obtenerCodigoEntrada(data);
      const cantidad = obtenerCantidad(data);

      if (!inventario[codigo]) {
        inventario[codigo] = {
          descripcion: "-",
          entradas: 0,
          salidas: 0,
          descEntrada: "",
          descInterna: ""
        };
      }

      inventario[codigo].salidas += cantidad;

    });

    dibujarTabla();
  });
}


// =====================================================
// Cargar descripciones finales
// =====================================================
async function actualizarDescripciones() {

  for (const codigo of Object.keys(inventario)) {
inventario[codigo].descripcion =
 inventario[codigo].descEntrada ||
 inventario[codigo].descInterna ||
 await obtenerDescripcion(codigo);

  }

  dibujarTabla();
}


// =====================================================
// TABLA
// =====================================================
function dibujarTabla() {

  tabla.innerHTML = "";

  Object.keys(inventario).forEach(codigo => {

    const p = inventario[codigo];
    const existencia = p.entradas - p.salidas;

    tabla.innerHTML += `
      <tr>
        <td>${codigo}</td>
        <td>${p.descripcion}</td>
        <td>${p.entradas}</td>
        <td>${p.salidas}</td>
        <td class="${existencia < 0 ? 'negativo' : 'positivo'}">${existencia}</td>
      </tr>
    `;
  });
}


// =====================================================
// INICIO
// =====================================================
procesarEntradas(collection(db, "almacenes/almacen_zapata/entradas"));
procesarSalidas(collection(db, "almacenes/almacen_zapata/salidas"));

</script>
</body>
</html>
