<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Inventario Real – Almacén Zapata</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
 body{
   font-family: Arial, sans-serif;
   background:#f2f2f2;
   padding:20px;
 }
 table{
   width:100%;
   border-collapse:collapse;
   background:white;
   margin-bottom:35px;
 }
 th,td{
   border:1px solid #ccc;
   padding:8px;
   text-align:center;
 }
 th{
   background:#00416A;
   color:white;
 }
 input.stock-edit{
   width:80px;
   padding:4px;
   text-align:center;
 }
 button{
   background:#00416A;
   color:white;
   padding:10px 20px;
   border:none;
   border-radius:5px;
   margin:15px 0;
   font-weight:bold;
   cursor:pointer;
 }
 button:hover{
   background:#003257;
 }
 .lineaTitulo {
   background:#003257 !important;
   color:white;
   font-size:18px;
   font-weight:bold;
   text-align:left;
   padding:10px;
 }
</style>
</head>
<body>

<h2>Inventario Real – Almacén Zapata</h2>

<button id="btnGuardar">Guardar Ajustes</button>

<div id="contenedorTablas"></div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getFirestore, collection, getDocs, addDoc 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.appspot.com",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:d2f1e80b17f123456789"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Fecha base para inventario inicial
const FECHA_INICIAL = new Date("2025-11-06");

// ORDEN PERSONALIZADO DE LÍNEAS
const ordenLineas = [
  "REYMA",
  "JAGUAR",
  "BIOPLAST",
  "CONVERMEX",
  "BOLSAS PLASTICAS",
  "PLASTIENVASE",
  "DESECHABLE",
  "OTROS"
];

let inventarioGlobal = {};

async function cargarInventario() {
  let totales = {}; 

  // ======================
  // 1) LEER ENTRADAS
  // ======================
  const entradasRef = collection(db, "almacenes", "almacen_zapata", "entradas");
  const snapEntradas = await getDocs(entradasRef);

  snapEntradas.forEach(doc => {
    const d = doc.data();

    const fechaEntrada = new Date(d.fechaDistribucion ?? d.fecha ?? "2000-01-01");
    const linea = d.linea ?? detectarLinea(d.descripcion);

    if (d.tipoMovimiento === "entrada_inicial" && d.fecha === "2025-11-06") {
      agregarEntrada(d.codigo, d.descripcion, linea, d.cantidad);
    }

    if (fechaEntrada > FECHA_INICIAL) {
      const codigo = d.codigo ?? d.productoId;
      agregarEntrada(codigo, d.descripcion, linea, d.cantidad);
    }
  });


  // ======================
  // 2) LEER SALIDAS
  // ======================
  const salidasRef = collection(db, "almacenes", "almacen_zapata", "salidas");
  const snapSalidas = await getDocs(salidasRef);

  snapSalidas.forEach(doc => {
    const d = doc.data();
    const fechaSalida = new Date(d.fecha);

    if (fechaSalida >= FECHA_INICIAL && Array.isArray(d.articulos)) {
      d.articulos.forEach(a => {
        const codigo = a.codigo;
        const descripcion = a.nombre ?? "";
        const linea = detectarLinea(descripcion);
        agregarSalida(codigo, descripcion, linea, Number(a.cantidad));
      });
    }
  });


  // ======================
  // FUNCIONES
  // ======================
  function detectarLinea(desc = "") {
    desc = desc.toUpperCase();

    if (desc.includes("REYMA")) return "REYMA";
    if (desc.includes("JAGUAR")) return "JAGUAR";
    if (desc.includes("BIOPLAST")) return "BIOPLAST";
    if (desc.includes("CONVERMEX")) return "CONVERMEX";
    if (desc.includes("BOLSA")) return "BOLSAS PLASTICAS";
    if (desc.includes("PLASTI")) return "PLASTIENVASE";

    return "OTROS";
  }

  function agregarEntrada(codigo, descripcion, linea, cant) {
    if (!codigo) return;

    if (!totales[codigo]) {
      totales[codigo] = { descripcion, linea, entradas: 0, salidas: 0 };
    }

    totales[codigo].linea = linea;
    totales[codigo].entradas += Number(cant || 0);
  }

  function agregarSalida(codigo, descripcion, linea, cant) {
    if (!codigo) return;

    if (!totales[codigo]) {
      totales[codigo] = { descripcion, linea, entradas: 0, salidas: 0 };
    }

    totales[codigo].linea = linea;
    totales[codigo].salidas += Number(cant || 0);
  }

  inventarioGlobal = totales;

  dibujarTablas(totales);
}


// ==============================
// 3) CREAR TABLAS POR LÍNEA
// ==============================
function dibujarTablas(totales) {
  const cont = document.getElementById("contenedorTablas");
  cont.innerHTML = "";

  // AGRUPAR POR LÍNEA
  let grupos = {};
  Object.keys(totales).forEach(codigo => {
    const item = totales[codigo];
    if (!grupos[item.linea]) grupos[item.linea] = [];
    grupos[item.linea].push({ codigo, ...item });
  });

  // ORDENAR SEGÚN LA LISTA PERSONALIZADA
  ordenLineas.forEach(linea => {
    if (!grupos[linea]) return;

    let tabla = `
      <table>
        <tr><td class="lineaTitulo" colspan="4">${linea}</td></tr>
        <tr>
          <th>Código</th>
          <th>Descripción</th>
          <th>Stock</th>
          <th>Editar</th>
        </tr>
    `;

    grupos[linea].forEach(p => {
      const stock = p.entradas - p.salidas;

      tabla += `
      <tr>
        <td>${p.codigo}</td>
        <td>${p.descripcion}</td>
        <td><b>${stock}</b></td>
        <td><input type="number" class="stock-edit" value="${stock}" data-codigo="${p.codigo}"></td>
      </tr>`;
    });

    tabla += "</table>";
    cont.innerHTML += tabla;
  });
}


// ======================
// 4) GUARDAR AJUSTES
// ======================
document.getElementById("btnGuardar").addEventListener("click", async () => {
  const inputs = document.querySelectorAll(".stock-edit");

  for (let input of inputs) {
    const codigo = input.dataset.codigo;
    const nuevo = Number(input.value);

    const p = inventarioGlobal[codigo];
    const actual = p.entradas - p.salidas;

    const diferencia = nuevo - actual;
    if (diferencia === 0) continue;

    const tipo = diferencia > 0 ? "entradas" : "salidas";
    const cantidadAjuste = Math.abs(diferencia);

    const ref = collection(db, "almacenes", "almacen_zapata", tipo);

    await addDoc(ref, {
      codigo,
      descripcion: p.descripcion,
      cantidad: cantidadAjuste,
      tipoMovimiento: "ajuste_manual",
      linea: p.linea,
      fecha: new Date().toISOString().split("T")[0],
      usuario: "Ajuste Inventario"
    });
  }

  alert("Ajustes guardados");
  cargarInventario();
});


// Ejecutar
cargarInventario();
</script>

</body>
</html>
